[TOC]

# Java性能调优

> 要进行优化，先得找到性能瓶颈
>
> 就是增加吞吐量，降低响应时间，在两者之间达到平衡，满足业务要求
>
> 就是要找到，影响吞吐量和响应时间的地方

* 吞吐量：每秒钟处理的请求数，任务数
* 响应时间：系统处理一个请求或一个任务的响应时间

## 解决步骤

* 当发生瓶颈时，先查看操作系统报告
  * CPU利用率
  * 内存使用率
  * 磁盘IO
  * 网络IO
  * 网络连接数
* 再查看虚拟机报告
  * GC快照



## 性能短板

* 磁盘I/O：等待磁盘读写完成，造成浪费了大量CPU时间，拖累整个系统
  * 使用NIO、零拷贝、mmap映射等技术，尽量异步读写硬盘，使用缓存和缓冲区技术。使用SSD硬盘，使用RAID技术提高写入性能 
* 网络请求：由于网络不稳定或拥塞控制等都会降低网络请求效率，如果等待网络请求结束或者超时时间设置过长会浪费大量CPU时间，拖累整个系统 
  * CDN或PCDN加速、缓存、合并请求、压缩报文，尽量异步网络请求（消息队列服务、master-worker等），使用NIO。加大带宽、升级网卡 
* CPU：一些运算对CPU直接或者不间断占用很大，CPU密集型应用会在CPU上产生瓶颈 
  * 持续优化代码，利用好多线程或多进程，设计合理架构，拆分业务，减少单机复杂运算，避免复杂运算和业务请求掺杂在一起 
* 数据库：关系型数据库在存盘读盘操作（即磁盘I/O操作），更新索引、锁等待和竞争都会产生瓶颈 
  * 优化sql语句，注意执行计划，使用缓存代替数据库部分功能，根据情景使用合理的存储引擎，注意锁，使用连接池，使用PrepareStatment 
* 锁竞争：高并发应用线程之间互相锁的竞争，线程上下文切换都是很大的开销 
  * 尽量减少锁竞争，可以使用无锁的copy-on-write、重入锁等技术 



## **Amdahl** 定律

* 优化的效果取决于CPU数量以及系统中串行化程序比重，CPU数量越多，串行比越低，优化效果越好



## 性能调优层次

* 架构调优
* 代码调优
* JVM调优
* 数据库调优
* 操作系统调优 

不要因为优化而优化！



## 优化方法

* 合并网络请求，减少网络请求
* 缓存热数据
* 池技术：线程池、连接池、对象池
* 并行化：充分利用cpu资源，采用多进程、多线程等技术
* 负载均衡：分发请求，减小单机压力
* 时间和空间转换



## 性能优化步骤

* 查看数据库报告，如ORACLE的AWR，看看数据库繁忙状态和一些TOP指令
* 再看看服务器性能，服务器的CPU和内存使用率
* 查看JVM状态，GC日志，看看young GC，full GC是否频繁，GC前后堆的大小，查看堆内存分配情况
* 查看最耗CPU的线程
* 查看最耗内存的线程
* 查看各个线程的状态
* 查看哪个方法平均耗时最长

## 参考文献

[java性能优化](https://blog.csdn.net/burpee/article/details/52535789)